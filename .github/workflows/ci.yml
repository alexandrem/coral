name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ------------------------------------------------------------
  # Base setup reused by all jobs
  # ------------------------------------------------------------
  base:
    name: Base Environment
    runs-on: ubuntu-latest
    outputs:
      go-cache-key: ${{ steps.go-cache-key.outputs.key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install APT prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y $(cat .github/apt-packages.txt)

      # -------- Go setup + cache --------
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.1"
          cache: true

      # Create a deterministic key for Go tool caching
      - id: go-cache-key
        name: Compute Go tools cache key
        run: echo "key=${{ runner.os }}-go-tools-$(sha256sum Makefile go.sum | sha256sum | cut -c1-16)" >> $GITHUB_OUTPUT

      - name: Cache Go tooling (go install)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
            ~/go/bin
          key: ${{ steps.go-cache-key.outputs.key }}

      - name: Install tools (cached)
        run: make install-tools

  # ------------------------------------------------------------
  # Tests
  # ------------------------------------------------------------
  test:
    needs: base
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Restore Go tools cache
        uses: actions/cache@v4
        with:
          path: ~/go/bin
          key: ${{ needs.base.outputs.go-cache-key }}

      - name: Go mod download
        run: go mod download

      - name: Run tests
        run: make test

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage.out
            test-results.xml
          retention-days: 30
        continue-on-error: true

  # ------------------------------------------------------------
  # Static analysis (Lint + Vet + Format)
  # ------------------------------------------------------------
  static-analysis:
    needs: base
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Restore Go tools cache
        uses: actions/cache@v4
        with:
          path: ~/go/bin
          key: ${{ needs.base.outputs.go-cache-key }}

      - name: Go generate
        run: make generate

      - name: Lint
        run: make lint

      - name: Vet
        run: make vet

      - name: Format check
        run: |
          goimports -l . > fmt-issues.txt
          if [ -s fmt-issues.txt ]; then
            echo "Formatting issues found:"
            cat fmt-issues.txt
            exit 1
          fi

  # ------------------------------------------------------------
  # Build job
  # ------------------------------------------------------------
  build:
    needs: base
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Restore Go tools cache
        uses: actions/cache@v4
        with:
          path: ~/go/bin
          key: ${{ needs.base.outputs.go-cache-key }}

      - name: Generate code
        run: make generate

      - name: Build binaries
        run: make build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: bin/
          retention-days: 7

  # ------------------------------------------------------------
  # Security scanning
  # ------------------------------------------------------------
  security:
    needs: base
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Gosec
        uses: securego/gosec@master
        with:
          args: "-no-fail -fmt sarif -out results.sarif ./..."
        continue-on-error: true

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        continue-on-error: true

  # ------------------------------------------------------------
  # Dependency checks
  # ------------------------------------------------------------
  dependencies:
    needs: base
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify dependencies
        run: |
          go mod verify
          go mod tidy
          git diff --exit-code go.mod go.sum || (echo "go.mod or go.sum need tidying"; exit 1)
