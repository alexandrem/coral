name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write    # for coverage comments, CodeQL
  checks: write           # for test results

env:
  GOPROXY: https://proxy.golang.org,direct
  GOSUMDB: sum.golang.org
  GO_VERSION: "1.25.1"

jobs:
  # ──────────────────────────────────────────────────────────────
  # Single source of truth: caches modules + build cache + tools
  # ──────────────────────────────────────────────────────────────
  go-env:
    name: Cache Go modules & tools
    runs-on: ubuntu-latest
    outputs:
      mod-cache-key: ${{ steps.mod.outputs.cache-key }}
      tools-cache-key: ${{ steps.tools.outputs.cache-key }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install APT packages
        run: |
          sudo apt-get update -q
          sudo apt-get install -y $(cat .github/apt-packages.txt || echo "")

      # ── Go modules cache key (100% reliable) ──
      - name: Go mod cache key
        id: mod
        run: |
          echo "cache-key=go-mod-v5-${{ runner.os }}-${{ hashFiles('go.mod', 'go.sum') }}" >> $GITHUB_OUTPUT

      - name: Cache Go modules & build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ steps.mod.outputs.cache-key }}
          restore-keys: |
            go-mod-v5-${{ runner.os }}-

      # ── Go tools cache key (100% reliable) ──
      - name: Go tools cache key
        id: tools
        run: |
          echo "cache-key=go-tools-v4-${{ runner.os }}-${{ hashFiles('go.mod', 'go.sum') }}" >> $GITHUB_OUTPUT

      - name: Cache Go tools
        uses: actions/cache@v4
        with:
          path: ~/go/bin
          key: ${{ steps.tools.outputs.cache-key }}
          restore-keys: |
            go-tools-v4-${{ runner.os }}-

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Install Go tools
        run: make install-tools || make install-tools  # retry once if needed

      - name: Download modules
        run: go mod download

  # ──────────────────────────────────────────────────────────────
  # Tests + Coverage
  # ──────────────────────────────────────────────────────────────
  test:
    needs: go-env
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install APT packages
        run: |
          sudo apt-get update
          sudo apt-get install -y $(cat .github/apt-packages.txt || echo "")

      - uses: actions/cache/restore@v4
        with:
          key: ${{ needs.go-env.outputs.mod-cache-key }}
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build

      - uses: actions/cache/restore@v4
        with:
          key: ${{ needs.go-env.outputs.tools-cache-key }}
          path: ~/go/bin

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Add tools to PATH
        run: echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Run tests with coverage
        run: make test-ci   # should run: go test -race -coverprofile=coverage.out -covermode=atomic ./...

  # ──────────────────────────────────────────────────────────────
  # Static Analysis
  # ──────────────────────────────────────────────────────────────
  static-analysis:
    needs: go-env
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install APT packages
        run: |
          sudo apt-get update
          sudo apt-get install -y $(cat .github/apt-packages.txt || echo "")

      - uses: actions/cache/restore@v4
        with:
          key: ${{ needs.go-env.outputs.mod-cache-key }}
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build

      - uses: actions/cache/restore@v4
        with:
          key: ${{ needs.go-env.outputs.tools-cache-key }}
          path: ~/go/bin

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Add tools to PATH
        run: echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Check go generate
        run: |
          make generate
          git diff --exit-code || (echo "go generate changed files — commit them!" && exit 1)

      - name: Lint
        run: make lint

      - name: Vet
        run: make vet

      - name: Format check
        run: |
          if [ -n "$(goimports -l .)" ]; then
            echo "Files need formatting: run 'goimports -w .'"
            exit 1
          fi

  # ──────────────────────────────────────────────────────────────
  # Build
  # ──────────────────────────────────────────────────────────────
  build:
    needs: go-env
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact-os: linux
            artifact-arch: amd64
          - os: macos-13  # Intel Mac for amd64
            artifact-os: darwin
            artifact-arch: amd64
          - os: macos-latest  # Apple Silicon for arm64
            artifact-os: darwin
            artifact-arch: arm64

    steps:
      - uses: actions/checkout@v4

      - name: Install APT packages (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y $(cat .github/apt-packages.txt || echo "")

      - name: Install Homebrew packages (macOS only)
        if: runner.os == 'macOS'
        run: |
          brew install llvm

      - uses: actions/cache/restore@v4
        with:
          key: ${{ needs.go-env.outputs.mod-cache-key }}
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build

      - uses: actions/cache/restore@v4
        with:
          key: ${{ needs.go-env.outputs.tools-cache-key }}
          path: ~/go/bin

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Add tools to PATH
        run: echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Build
        run: make build

      # Unique, predictable artifact name
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-os }}-${{ matrix.artifact-arch }}-binaries
          path: bin/
          # Or more precise: bin/${{ matrix.artifact-os }}_${{ matrix.artifact-arch }}/**
          retention-days: 30
          if-no-files-found: error

  # ------------------------------------------------------------
  # Security scanning
  # ------------------------------------------------------------
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Recommended: Consider using CodeQL for better integration with GitHub Security features.
      - name: Run Gosec
        uses: securego/gosec@master
        with:
          args: "-no-fail -fmt sarif -out results.sarif ./..."
        continue-on-error: true

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        continue-on-error: true

  # ------------------------------------------------------------
  # Dependency checks
  # ------------------------------------------------------------
  dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # NOTE: No Go tool cache restore is needed here since 'go mod' commands don't rely on ~/go/bin.

      - name: Verify dependencies
        run: |
          # This command ensures all downloaded modules are present and match go.sum
          go mod verify

          # We don't run 'go mod tidy' to avoid modifying the repository state,
          # but we check if it *would* change anything.
          go mod tidy
          git diff --exit-code go.mod go.sum || (echo "go.mod or go.sum need tidying"; exit 1)
