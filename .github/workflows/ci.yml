name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ------------------------------------------------------------
  # Base setup reused by all jobs
  # ------------------------------------------------------------
  base:
    name: Base Environment Setup
    runs-on: ubuntu-latest
    outputs:
      go-tool-cache-key: ${{ steps.go-tool-cache-key.outputs.key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install APT prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y $(cat .github/apt-packages.txt)

      # -------- Go setup + cache (Handles Go module dependencies) --------
      - name: Setup Go and Cache Modules
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.1"
          # This caches Go modules (~/go/pkg/mod) and build cache (~/.cache/go-build)
          cache: true

      - id: go-tool-cache-key
        name: Compute Go tools cache key
        run: |
          # The key format must be 'name=value' written directly to the $GITHUB_OUTPUT file.
          # We use a single command block to calculate and set the output correctly.
          HASH=$(sha256sum go.mod go.sum | cut -c1-32)
          echo "key=Linux-go-tools-$HASH" >> $GITHUB_OUTPUT

      # Cache Go Tooling binaries (~/go/bin) installed via 'make install-tools'
      - name: Cache/Restore Go tooling binaries
        uses: actions/cache@v4
        with:
          path: ~/go/bin
          key: ${{ steps.go-tool-cache-key.outputs.key }}
          # Use a restore-key for partial matches if the exact key misses (improves hit rate)
          restore-keys: ${{ runner.os }}-go-tools-

      - name: Install tools (cached)
        # This step will only run 'go install' commands if the cache was missed.
        run: make install-tools

  # ------------------------------------------------------------
  # Tests
  # ------------------------------------------------------------
  test:
    needs: base
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Restore Go tools cache
        uses: actions/cache@v4
        with:
          path: ~/go/bin
          key: ${{ needs.base.outputs.go-tool-cache-key }}
          restore-keys: ${{ runner.os }}-go-tools- # Added restore-key

      # NOTE: 'go mod download' is usually redundant because 'actions/setup-go'
      # in the base job already handled module caching. It's removed for efficiency.

      - name: Run tests
        run: make test

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage.out
            test-results.xml
          retention-days: 30
        continue-on-error: true

  # ------------------------------------------------------------
  # Static analysis (Lint + Vet + Format)
  # ------------------------------------------------------------
  static-analysis:
    needs: base
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Restore Go tools cache
        uses: actions/cache@v4
        with:
          path: ~/go/bin
          key: ${{ needs.base.outputs.go-tool-cache-key }}
          restore-keys: ${{ runner.os }}-go-tools- # Added restore-key

      - name: Go generate
        run: make generate

      - name: Lint
        run: make lint

      - name: Vet
        run: make vet

      - name: Format check
        run: |
          goimports -l . > fmt-issues.txt
          if [ -s fmt-issues.txt ]; then
            echo "Formatting issues found:"
            cat fmt-issues.txt
            exit 1
          fi

  # ------------------------------------------------------------
  # Build job
  # ------------------------------------------------------------
  build:
    needs: base
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Restore Go tools cache
        uses: actions/cache@v4
        with:
          path: ~/go/bin
          key: ${{ needs.base.outputs.go-tool-cache-key }}
          restore-keys: ${{ runner.os }}-go-tools- # Added restore-key

      - name: Generate code
        run: make generate

      - name: Build binaries
        run: make build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: bin/
          retention-days: 7

  # ------------------------------------------------------------
  # Security scanning
  # ------------------------------------------------------------
  security:
    needs: base
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Recommended: Consider using CodeQL for better integration with GitHub Security features.
      - name: Run Gosec
        uses: securego/gosec@master
        with:
          args: "-no-fail -fmt sarif -out results.sarif ./..."
        continue-on-error: true

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        continue-on-error: true

  # ------------------------------------------------------------
  # Dependency checks
  # ------------------------------------------------------------
  dependencies:
    needs: base
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # NOTE: No Go tool cache restore is needed here since 'go mod' commands don't rely on ~/go/bin.

      - name: Verify dependencies
        run: |
          # This command ensures all downloaded modules are present and match go.sum
          go mod verify

          # We don't run 'go mod tidy' to avoid modifying the repository state,
          # but we check if it *would* change anything.
          go mod tidy
          git diff --exit-code go.mod go.sum || (echo "go.mod or go.sum need tidying"; exit 1)
