# Base Coral Infrastructure
# This compose file defines the core components:
# - Colony (AI coordinator)
# - Agents (2 instances)
#
# Use overlays for specific environments:
# - docker-compose.dev.yml: adds test apps for local development
# - docker-compose.dev-local-discovery.yml: uses local discovery service
# - tests/e2e/distributed/docker-compose.e2e.yml: fast polling for tests

services:
  # Colony - AI coordinator with DuckDB storage
  colony:
    build:
      context: .
      dockerfile: Dockerfile
    entrypoint: /bin/sh
    command:
      - -c
      - |
        # Initialize colony if config doesn't exist
        if [ ! -f /var/lib/coral/.colony_id ] || [ ! -d /root/.coral/colonies/coral-dev-* ]; then
          echo "Initializing colony..."
          /usr/local/bin/coral init coral-dev --env dev --storage /var/lib/coral --discovery $${CORAL_DISCOVERY_ENDPOINT}
          # Find the generated colony directory
          COLONY_DIR=$$(ls -1d /root/.coral/colonies/coral-dev-* 2>/dev/null | head -1)
          if [ -n "$$COLONY_DIR" ]; then
            COLONY_ID=$$(basename "$$COLONY_DIR")
            echo "$$COLONY_ID" > /var/lib/coral/.colony_id
            # Share colony ID with agents
            echo "$$COLONY_ID" > /shared/colony_id
            echo "Colony ID saved to shared volume: $$COLONY_ID"

            # Calculate and share Root CA fingerprint for agent bootstrap (RFD 048)
            ROOT_CA_PATH="$$COLONY_DIR/ca/root-ca.crt"
            if [ -f "$$ROOT_CA_PATH" ]; then
              # Calculate SHA256 fingerprint of the Root CA certificate
              FINGERPRINT=$$(openssl x509 -in "$$ROOT_CA_PATH" -noout -fingerprint -sha256 | sed 's/.*=//;s/://g' | tr '[:upper:]' '[:lower:]')
              echo "sha256:$$FINGERPRINT" > /shared/ca_fingerprint
              echo "CA fingerprint saved: sha256:$$FINGERPRINT"
            fi
          fi
        else
          echo "Colony already initialized, using existing config"
          # Ensure colony ID is shared
          if [ -f /var/lib/coral/.colony_id ]; then
            cp /var/lib/coral/.colony_id /shared/colony_id
            # Also ensure fingerprint is shared
            COLONY_ID=$$(cat /var/lib/coral/.colony_id)
            COLONY_DIR="/root/.coral/colonies/$$COLONY_ID"
            ROOT_CA_PATH="$$COLONY_DIR/ca/root-ca.crt"
            if [ -f "$$ROOT_CA_PATH" ] && [ ! -f /shared/ca_fingerprint ]; then
              FINGERPRINT=$$(openssl x509 -in "$$ROOT_CA_PATH" -noout -fingerprint -sha256 | sed 's/.*=//;s/://g' | tr '[:upper:]' '[:lower:]')
              echo "sha256:$$FINGERPRINT" > /shared/ca_fingerprint
              echo "CA fingerprint saved: sha256:$$FINGERPRINT"
            fi
          fi
        fi
        # Read the actual colony ID and configure settings
        if [ -f /var/lib/coral/.colony_id ]; then
          COLONY_ID=$$(cat /var/lib/coral/.colony_id)
          echo "Starting colony with ID: $$COLONY_ID"

          # Apply public endpoint settings via overlay
          CONFIG_FILE="/root/.coral/colonies/$$COLONY_ID/config.yaml"
          if [ -f "$$CONFIG_FILE" ] && [ ! -f "$$CONFIG_FILE.public_applied" ]; then
            echo "Applying public endpoint settings..."
            printf "\npublic_endpoint:\n  enabled: true\n  host: 0.0.0.0\n  port: 8443\n  auth:\n    require: true\n" >> "$$CONFIG_FILE"
            touch "$$CONFIG_FILE.public_applied"
          fi

          exec /usr/local/bin/coral colony start --colony "$$COLONY_ID"
        else
          # Fallback to auto-detection
          exec /usr/local/bin/coral colony start
        fi
    environment:
      - CORAL_DISCOVERY_ENDPOINT=https://coral-discovery.alexandre-mclean.workers.dev
      - CORAL_PUBLIC_ENDPOINT=colony:51820
      - CORAL_STORAGE_PATH=/var/lib/coral
    ports:
      - "9000:9000"     # gRPC
      - "8443:8443"     # HTTPS public endpoint
      - "51820:51820/udp" # WireGuard
    privileged: true # Required for WireGuard
    healthcheck:
      test: ["CMD", "coral", "colony", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - coral
    volumes:
      - colony-data:/var/lib/coral
      - colony-shared:/shared
      - colony-config:/root/.coral

  # Agent 0 - Primary agent
  agent-0:
    build:
      context: .
      dockerfile: Dockerfile
    entrypoint: /bin/sh
    command:
      - -c
      - |
        # Wait for colony to write its ID and CA fingerprint
        echo "Waiting for colony initialization..."
        while [ ! -f /shared/colony_id ]; do
          echo "  Waiting for colony ID..."
          sleep 2
        done
        while [ ! -f /shared/ca_fingerprint ]; do
          echo "  Waiting for CA fingerprint..."
          sleep 2
        done
        COLONY_ID=$$(cat /shared/colony_id)
        CA_FINGERPRINT=$$(cat /shared/ca_fingerprint)
        echo "Starting agent with colony ID: $$COLONY_ID"
        echo "Using CA fingerprint: $$CA_FINGERPRINT"
        export CORAL_COLONY_ID="$$COLONY_ID"
        export CORAL_CA_FINGERPRINT="$$CA_FINGERPRINT"
        exec /usr/local/bin/coral agent start --monitor-all
    environment:
      - CORAL_DISCOVERY_ENDPOINT=https://coral-discovery.alexandre-mclean.workers.dev
      - CORAL_AGENT_BIND_ALL=true
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "9001:9001"   # Agent gRPC
      - "8081:8080"   # App port (for cpu-app in shared namespace)
      - "8082:8090"   # App port (for otel-app in shared namespace)
    privileged: true # Required for eBPF and WireGuard
    depends_on:
      - colony
    healthcheck:
      test: ["CMD", "coral", "agent", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - coral
    volumes:
      - agent-0-data:/var/lib/coral
      - colony-shared:/shared
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

  # Agent 1 - Secondary agent
  agent-1:
    build:
      context: .
      dockerfile: Dockerfile
    entrypoint: /bin/sh
    command:
      - -c
      - |
        # Wait for colony to write its ID and CA fingerprint
        echo "Waiting for colony initialization..."
        while [ ! -f /shared/colony_id ]; do
          echo "  Waiting for colony ID..."
          sleep 2
        done
        while [ ! -f /shared/ca_fingerprint ]; do
          echo "  Waiting for CA fingerprint..."
          sleep 2
        done
        COLONY_ID=$$(cat /shared/colony_id)
        CA_FINGERPRINT=$$(cat /shared/ca_fingerprint)
        echo "Starting agent with colony ID: $$COLONY_ID"
        echo "Using CA fingerprint: $$CA_FINGERPRINT"
        export CORAL_COLONY_ID="$$COLONY_ID"
        export CORAL_CA_FINGERPRINT="$$CA_FINGERPRINT"
        exec /usr/local/bin/coral agent start --monitor-all
    environment:
      - CORAL_DISCOVERY_ENDPOINT=https://coral-discovery.alexandre-mclean.workers.dev
      - CORAL_AGENT_BIND_ALL=true
    ports:
      - "4327:4317"   # OTLP gRPC
      - "4328:4318"   # OTLP HTTP
      - "9002:9001"   # Agent gRPC
      - "3001:3001"   # App port (for sdk-app in shared namespace)
      - "9003:9002"   # App debug port
    privileged: true
    depends_on:
      - colony
    healthcheck:
      test: ["CMD", "coral", "agent", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - coral
    volumes:
      - agent-1-data:/var/lib/coral
      - colony-shared:/shared
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

networks:
  coral:
    driver: bridge

volumes:
  colony-data:
  colony-shared:
  colony-config:
  agent-0-data:
  agent-1-data:
