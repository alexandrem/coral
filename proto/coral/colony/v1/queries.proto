syntax = "proto3";

package coral.colony.v1;

import "google/protobuf/timestamp.proto";
import "coral/agent/v1/agent.proto";

option go_package = "github.com/coral-mesh/coral/proto/colony/v1;colonypb";

// Unified Query Interface (RFD 067) - comprehensive queries for detailed analysis.

message QueryUnifiedSummaryRequest {
  // Optional: specific service or all services.
  string service = 1;

  // Time range (e.g., "5m", "1h").
  string time_range = 2;
}

message UnifiedSummaryResult {
  // Service name.
  string service_name = 1;

  // Health status: healthy, degraded, critical.
  string status = 2;

  // Total requests/spans.
  int64 request_count = 3;

  // Error rate as percentage (0-100).
  double error_rate = 4;

  // Average latency in milliseconds.
  double avg_latency_ms = 5;

  // Data source: eBPF, OTLP, or eBPF+OTLP.
  string source = 6;

  // Issues detected (human-readable descriptions).
  repeated string issues = 7;

  // Host resources (RFD 071).
  double host_cpu_utilization = 8;      // CPU utilization percentage (max in time window)
  double host_cpu_utilization_avg = 9;  // CPU utilization percentage (average in time window)
  double host_memory_usage_gb = 10;     // Memory usage in GB (max in time window)
  double host_memory_limit_gb = 11;     // Memory limit in GB
  double host_memory_utilization = 12;  // Memory utilization percentage (max in time window)
  string agent_id = 13;                 // Agent ID for correlation
}

message QueryUnifiedSummaryResponse {
  // Structured summary results.
  repeated UnifiedSummaryResult summaries = 1;
}

message QueryUnifiedTracesRequest {
  // Optional: filter by service.
  string service = 1;

  // Time range (default: "1h").
  string time_range = 2;

  // Optional: ebpf|telemetry|all (default: all).
  string source = 3;

  // Optional: specific trace ID.
  string trace_id = 4;

  // Optional: filter slow traces (milliseconds).
  int32 min_duration_ms = 5;

  // Maximum traces to return.
  int32 max_traces = 6;
}

message QueryUnifiedTracesResponse {
  // Structured trace spans (eBPF + OTLP).
  repeated coral.agent.v1.EbpfTraceSpan spans = 1;

  // Total traces returned.
  int32 total_traces = 2;
}

message QueryUnifiedMetricsRequest {
  // Optional: filter by service.
  string service = 1;

  // Time range (default: "1h").
  string time_range = 2;

  // Optional: ebpf|telemetry|all (default: all).
  string source = 3;

  // Optional: http|grpc|sql|auto (default: auto).
  string protocol = 4;

  // Optional: HTTP route filter.
  string http_route = 5;

  // Optional: HTTP method filter.
  string http_method = 6;

  // Optional: HTTP status code range filter.
  string status_code_range = 7;
}

message QueryUnifiedMetricsResponse {
  // Structured HTTP metrics (eBPF + OTLP).
  repeated coral.agent.v1.EbpfHttpMetric http_metrics = 1;

  // Structured gRPC metrics (eBPF + OTLP).
  repeated coral.agent.v1.EbpfGrpcMetric grpc_metrics = 2;

  // Structured SQL metrics (eBPF + OTLP).
  repeated coral.agent.v1.EbpfSqlMetric sql_metrics = 3;

  // Total metrics returned.
  int32 total_metrics = 4;
}

message QueryUnifiedLogsRequest {
  // Optional: filter by service.
  string service = 1;

  // Time range (default: "1h").
  string time_range = 2;

  // Optional: debug|info|warn|error.
  string level = 3;

  // Optional: full-text search.
  string search = 4;

  // Maximum logs to return.
  int32 max_logs = 5;
}

message UnifiedLogEntry {
  // Timestamp (Unix milliseconds).
  int64 timestamp = 1;

  // Service name.
  string service_name = 2;

  // Log level: debug, info, warn, error.
  string level = 3;

  // Log message.
  string message = 4;

  // Associated trace ID (if any).
  string trace_id = 5;

  // Additional attributes.
  map<string, string> attributes = 6;
}

message QueryUnifiedLogsResponse {
  // Structured log entries.
  repeated UnifiedLogEntry logs = 1;

  // Total logs returned.
  int32 total_logs = 2;
}

// Focused Query Interface (RFD 076) - focused queries for scripting and CLI.

// Service discovery.

// ServiceSource indicates where service information originated (RFD 084).
enum ServiceSource {
  SERVICE_SOURCE_UNSPECIFIED = 0;

  // Service is explicitly registered via ConnectService API.
  SERVICE_SOURCE_REGISTERED = 1;

  // Service is auto-discovered from telemetry data only.
  SERVICE_SOURCE_DISCOVERED = 2;

  // Service is both registered AND has telemetry data.
  SERVICE_SOURCE_BOTH = 3;
}

// ServiceStatus indicates the current registration and health status (RFD 084).
enum ServiceStatus {
  SERVICE_STATUS_UNSPECIFIED = 0;

  // Service is registered and passing health checks.
  SERVICE_STATUS_ACTIVE = 1;

  // Service is registered but health checks are failing.
  SERVICE_STATUS_UNHEALTHY = 2;

  // Service is no longer registered but has recent telemetry.
  SERVICE_STATUS_DISCONNECTED = 3;

  // Service is only known from telemetry, never explicitly registered.
  SERVICE_STATUS_DISCOVERED_ONLY = 4;
}

message ListServicesRequest {
  // Optional namespace filter.
  string namespace = 1;

  // Time range for telemetry-based discovery (e.g., "1h", "24h").
  // Defaults to "1h" if not specified.
  // Only affects telemetry-discovered services (RFD 084).
  string time_range = 2;

  // Filter by service source (RFD 084).
  // If unspecified, returns all services regardless of source.
  optional ServiceSource source_filter = 3;
}

message ListServicesResponse {
  repeated ServiceSummary services = 1;
}

message ServiceSummary {
  string name = 1;
  string namespace = 2;
  int32 instance_count = 3;
  google.protobuf.Timestamp last_seen = 4;

  // Indicates where this service information came from (RFD 084).
  ServiceSource source = 5;

  // Current registration and health status (if applicable) (RFD 084).
  // Only set when source includes SERVICE_SOURCE_REGISTERED.
  optional ServiceStatus status = 6;

  // Agent ID where service is registered (if applicable) (RFD 084).
  // Only set when source includes SERVICE_SOURCE_REGISTERED.
  optional string agent_id = 7;
}

// Focused metric queries.

message GetMetricPercentileRequest {
  // Service name.
  string service = 1;

  // Metric name (e.g., "http.server.duration").
  string metric = 2;

  // Percentile (0.0-1.0, e.g., 0.99 for P99).
  double percentile = 3;

  // Time range in milliseconds (default: 1 hour).
  int64 time_range_ms = 4;
}

message GetMetricPercentileResponse {
  // Percentile value in the metric's native unit.
  double value = 1;

  // Unit (e.g., "nanoseconds", "bytes").
  string unit = 2;

  // Timestamp of the query.
  google.protobuf.Timestamp timestamp = 3;
}

// Service activity metrics.

message GetServiceActivityRequest {
  // Service name.
  string service = 1;

  // Time range in milliseconds (default: 1 hour).
  int64 time_range_ms = 2;
}

message GetServiceActivityResponse {
  // Service name.
  string service_name = 1;

  // Total request count.
  int64 request_count = 2;

  // Error count (status >= 400).
  int64 error_count = 3;

  // Error rate (0.0-1.0).
  double error_rate = 4;

  // Timestamp of the query.
  google.protobuf.Timestamp timestamp = 5;
}

message ListServiceActivityRequest {
  // Time range in milliseconds (default: 1 hour).
  int64 time_range_ms = 1;
}

message ListServiceActivityResponse {
  // Activity stats for all services.
  repeated ServiceActivity services = 1;
}

message ServiceActivity {
  // Service name.
  string service_name = 1;

  // Total request count.
  int64 request_count = 2;

  // Error count (status >= 400).
  int64 error_count = 3;

  // Error rate (0.0-1.0).
  double error_rate = 4;
}

// Raw SQL execution.

message ExecuteQueryRequest {
  // SQL query string.
  string sql = 1;

  // Optional: maximum rows to return (default: 1000).
  int32 max_rows = 2;
}

message ExecuteQueryResponse {
  // Query results as rows.
  repeated QueryRow rows = 1;

  // Total rows returned.
  int32 row_count = 2;

  // Column names.
  repeated string columns = 3;
}

message QueryRow {
  // Column values (stringified).
  repeated string values = 1;
}
