syntax = "proto3";

package coral.colony.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";
import "coral/agent/v1/debug.proto";

option go_package = "github.com/coral-mesh/coral/proto/colony/v1;colonypb";

// ColonyDebugService handles live debugging operations (RFD 059).
service ColonyDebugService {
  // Start uprobe debug session.
  rpc AttachUprobe(AttachUprobeRequest) returns (AttachUprobeResponse);

  // Stop uprobe session.
  rpc DetachUprobe(DetachUprobeRequest) returns (DetachUprobeResponse);

  // Query uprobe events (pull-based, like Beyla).
  rpc QueryUprobeEvents(QueryUprobeEventsRequest) returns (QueryUprobeEventsResponse);

  // List active debug sessions.
  rpc ListDebugSessions(ListDebugSessionsRequest) returns (ListDebugSessionsResponse);

  // Trace request path (RFD 062).
  rpc TraceRequestPath(TraceRequestPathRequest) returns (TraceRequestPathResponse);

  // Get aggregated debug results (RFD 062).
  rpc GetDebugResults(GetDebugResultsRequest) returns (GetDebugResultsResponse);

  // Query functions with semantic search (RFD 069).
  rpc QueryFunctions(QueryFunctionsRequest) returns (QueryFunctionsResponse);

  // Profile multiple functions with automatic analysis (RFD 069).
  rpc ProfileFunctions(ProfileFunctionsRequest) returns (ProfileFunctionsResponse);

  // Collect CPU profile samples for a target service/pod (RFD 070).
  rpc ProfileCPU(ProfileCPURequest) returns (ProfileCPUResponse);

  // Query historical CPU profiles from continuous profiling (RFD 072).
  rpc QueryHistoricalCPUProfile(QueryHistoricalCPUProfileRequest) returns (QueryHistoricalCPUProfileResponse);

  // Collect memory profile for a target service/pod (RFD 077).
  rpc ProfileMemory(ProfileMemoryRequest) returns (ProfileMemoryResponse);

  // Query historical memory profiles from continuous profiling (RFD 077).
  rpc QueryHistoricalMemoryProfile(QueryHistoricalMemoryProfileRequest) returns (QueryHistoricalMemoryProfileResponse);
}

// AttachUprobeRequest initiates a debug session on a specific function.
message AttachUprobeRequest {
  string service_name = 1;
  string function_name = 2;
  google.protobuf.Duration duration = 3;  // Default: 60s, Max: 600s
  coral.agent.v1.UprobeConfig config = 4;
  string agent_id = 5;              // Manual override (until service discovery integration)
  string sdk_addr = 6;              // Manual override (until service discovery integration)
}

// AttachUprobeResponse confirms debug session creation.
message AttachUprobeResponse {
  string session_id = 1;
  google.protobuf.Timestamp expires_at = 2;
  bool success = 3;
  string error = 4;
}

// DetachUprobeRequest stops a debug session early.
message DetachUprobeRequest {
  string session_id = 1;
}

// DetachUprobeResponse confirms session termination.
message DetachUprobeResponse {
  bool success = 1;
  string error = 2;
}

// QueryUprobeEventsRequest retrieves events from a debug session.
message QueryUprobeEventsRequest {
  string session_id = 1;
  google.protobuf.Timestamp start_time = 2;
  google.protobuf.Timestamp end_time = 3;
  int32 max_events = 4;             // Pagination
}

// QueryUprobeEventsResponse returns captured events.
message QueryUprobeEventsResponse {
  repeated coral.agent.v1.UprobeEvent events = 1;
  bool has_more = 2;                // Pagination indicator
}

// ListDebugSessionsRequest retrieves active debug sessions.
message ListDebugSessionsRequest {
  // Optional filter by service name.
  string service_name = 1;
  // Optional filter by status.
  string status = 2;
}

// ListDebugSessionsResponse returns active sessions.
message ListDebugSessionsResponse {
  repeated DebugSession sessions = 1;
}

// DebugSession represents an active or completed debug session.
message DebugSession {
  string session_id = 1;
  string service_name = 2;
  string function_name = 3;
  string agent_id = 4;
  google.protobuf.Timestamp started_at = 5;
  google.protobuf.Timestamp expires_at = 6;
  string status = 7;                // "active", "expired", "stopped"
  string requested_by = 8;          // User who initiated session
  int32 event_count = 9;            // Number of events collected
}

// TraceRequestPathRequest initiates a request path trace.
message TraceRequestPathRequest {
  string service_name = 1;
  string path = 2;
  google.protobuf.Duration duration = 3;
  string sdk_addr = 4;              // SDK address for uprobe (optional, will try to discover)
}

// TraceRequestPathResponse returns the trace session details.
message TraceRequestPathResponse {
  string session_id = 1;
  string path = 2;
  // Call tree and bottleneck analysis would be returned here or queried later.
  // For now, we just return the session ID as it's an async process.
  bool success = 3;
  string error = 4;
}

// GetDebugResultsRequest retrieves aggregated results for a session.
message GetDebugResultsRequest {
  string session_id = 1;
  string format = 2; // "summary", "full", "histogram"
  string service_name = 3; // Optional, for routing if needed
}

// GetDebugResultsResponse returns the aggregated results.
message GetDebugResultsResponse {
  string session_id = 1;
  string function = 2;
  google.protobuf.Duration duration = 3;
  DebugStatistics statistics = 4;
  repeated SlowOutlier slow_outliers = 5;
  CallTree call_tree = 6;  // Hierarchical call tree from uprobe events
  int32 process_id = 7;
  string binary_path = 8;
}

message DebugStatistics {
  int64 total_calls = 1;
  google.protobuf.Duration duration_p50 = 2;
  google.protobuf.Duration duration_p95 = 3;
  google.protobuf.Duration duration_p99 = 4;
  google.protobuf.Duration duration_max = 5;
}

message SlowOutlier {
  google.protobuf.Duration duration = 1;
  google.protobuf.Timestamp timestamp = 2;
  map<string, string> labels = 3;
}

// CallTree represents the root of a hierarchical call tree.
message CallTree {
  CallTreeNode root = 1;
  int64 total_invocations = 2;  // Number of complete call trees captured
}

// CallTreeNode represents a node in the call tree hierarchy.
message CallTreeNode {
  string function_name = 1;
  google.protobuf.Duration total_duration = 2;  // Total time including children
  google.protobuf.Duration self_duration = 3;   // Time in this function only
  int64 call_count = 4;                         // Number of times this function was called
  repeated CallTreeNode children = 5;           // Child function calls
  bool is_slow = 6;                             // Exceeds P95 threshold
}

// QueryFunctionsRequest queries the function registry (RFD 069).
message QueryFunctionsRequest {
  string service_name = 1;          // Optional filter by service name
  string query = 2;                 // Semantic search query (keywords or regex)
  int32 max_results = 3;            // Max results (default: 20, max: 50)
  bool include_metrics = 4;         // Include performance metrics if available
  bool prioritize_slow = 5;         // Rank by P95 latency
}

// QueryFunctionsResponse returns discovered functions.
message QueryFunctionsResponse {
  string service_name = 1;
  string query = 2;
  int32 data_coverage_pct = 3;      // Percentage of results with metrics (0-100)
  repeated FunctionResult results = 4;
  string suggestion = 5;            // Recommendation for next action
}

// FunctionResult represents a discovered function with metadata.
message FunctionResult {
  FunctionMetadata function = 1;
  SearchInfo search = 2;
  FunctionMetrics metrics = 3;      // May be null if not instrumented
  InstrumentationInfo instrumentation = 4;
  string suggestion = 5;            // Present when action recommended
}

// FunctionMetadata contains static function information.
message FunctionMetadata {
  string id = 1;                    // Unique function ID
  string name = 2;                  // Full function name (e.g., "main.handleCheckout")
  string package = 3;               // Package name
  string file = 4;                  // Source file path
  int32 line = 5;                   // Line number
  string offset = 6;                // Function offset in binary
}

// SearchInfo contains search ranking metadata.
message SearchInfo {
  double score = 1;                 // Search relevance score (0-1)
  string reason = 2;                // Why this function matched
}

// FunctionMetrics contains performance data.
message FunctionMetrics {
  string source = 1;                // "probe_history" | "estimated" | null
  google.protobuf.Timestamp last_measured = 2;
  int64 sample_size = 3;
  google.protobuf.Duration p50 = 4;
  google.protobuf.Duration p95 = 5;
  google.protobuf.Duration p99 = 6;
  double calls_per_min = 7;
  double error_rate = 8;
}

// InstrumentationInfo contains probe availability metadata.
message InstrumentationInfo {
  bool is_probeable = 1;
  bool has_dwarf = 2;
  bool currently_probed = 3;
  google.protobuf.Timestamp last_probed = 4;
}

// ProfileFunctionsRequest initiates batch profiling (RFD 069).
message ProfileFunctionsRequest {
  string service_name = 1;
  string query = 2;                 // Semantic search query
  string strategy = 3;              // "critical_path" | "all" | "entry_points" | "leaf_functions"
  int32 max_functions = 4;          // Max functions to probe (default: 20, max: 50)
  google.protobuf.Duration duration = 5;  // Duration (default: 60s, max: 300s)
  bool async = 6;                   // Return immediately vs wait
  double sample_rate = 7;           // Event sampling: 0.1-1.0
}

// ProfileFunctionsResponse returns profiling results.
message ProfileFunctionsResponse {
  string session_id = 1;
  string status = 2;                // "completed" | "in_progress" | "partial_success" | "failed"
  string service_name = 3;
  string query = 4;
  string strategy = 5;
  ProfileSummary summary = 6;
  repeated ProfileResult results = 7;
  repeated Bottleneck bottlenecks = 8;
  string recommendation = 9;
  repeated string next_steps = 10;
}

// ProfileSummary contains high-level profiling statistics.
message ProfileSummary {
  int32 functions_selected = 1;
  int32 functions_probed = 2;
  int32 probes_failed = 3;
  int64 total_events_captured = 4;
  google.protobuf.Duration duration = 5;
}

// ProfileResult contains results for a single profiled function.
message ProfileResult {
  string function = 1;
  bool probe_successful = 2;
  FunctionMetrics metrics = 3;
  repeated CallContribution calls = 4;
}

// CallContribution represents a callee's contribution to execution time.
message CallContribution {
  string callee = 1;
  int32 contribution_pct = 2;       // Percentage of parent's time
  google.protobuf.Duration p95 = 3;
  bool is_bottleneck = 4;
}

// Bottleneck represents an identified performance bottleneck.
message Bottleneck {
  string function = 1;
  google.protobuf.Duration p95 = 2;
  int32 contribution_pct = 3;
  string severity = 4;              // "critical" | "major" | "minor"
  string impact = 5;
  string recommendation = 6;
}

// ProfileCPURequest initiates CPU profile collection (RFD 070).
message ProfileCPURequest {
  string service_name = 1;          // Target service name
  string pod_name = 2;              // Optional, specific pod instance
  int32 duration_seconds = 3;       // Profiling duration (default: 30s, max: 300s)
  int32 frequency_hz = 4;           // Sampling frequency (default: 99Hz, max: 1000Hz)
  string agent_id = 5;              // Manual override (until service discovery integration)
}

// ProfileCPUResponse returns CPU profile samples (RFD 070).
message ProfileCPUResponse {
  repeated coral.agent.v1.StackSample samples = 1; // Collected stack samples
  uint64 total_samples = 2;         // Total samples collected
  uint32 lost_samples = 3;          // Samples lost due to map overflow
  string error = 4;                 // Error message if collection failed
  bool success = 5;                 // Whether profiling succeeded
}

// QueryHistoricalCPUProfileRequest queries historical CPU profiles (RFD 072).
message QueryHistoricalCPUProfileRequest {
  string service_name = 1;                // Target service name
  google.protobuf.Timestamp start_time = 2;  // Query start time
  google.protobuf.Timestamp end_time = 3;    // Query end time
}

// QueryHistoricalCPUProfileResponse returns aggregated historical profiles (RFD 072).
message QueryHistoricalCPUProfileResponse {
  repeated coral.agent.v1.StackSample samples = 1; // Aggregated stack samples
  uint64 total_samples = 2;         // Total samples across time range
  string error = 3;                 // Error message if query failed
  bool success = 4;                 // Whether query succeeded
}

// ProfileMemoryRequest initiates memory profile collection (RFD 077).
message ProfileMemoryRequest {
  string service_name = 1;          // Target service name.
  string pod_name = 2;              // Optional, specific pod instance.
  int32 duration_seconds = 3;       // Profiling duration (default: 30s, max: 300s).
  int32 sample_rate_bytes = 4;      // Allocation sampling rate in bytes (default: 512KB).
  string agent_id = 5;              // Manual override (until service discovery integration).
}

// ProfileMemoryResponse returns memory profile results (RFD 077).
message ProfileMemoryResponse {
  repeated coral.agent.v1.MemoryStackSample samples = 1; // Collected allocation samples.
  coral.agent.v1.MemoryStats stats = 2;                  // Heap statistics.
  repeated coral.agent.v1.TopAllocFunction top_functions = 3; // Top allocating functions.
  repeated coral.agent.v1.TopAllocType top_types = 4;     // Top allocated types.
  string error = 5;                 // Error message if collection failed.
  bool success = 6;                 // Whether profiling succeeded.
}

// QueryHistoricalMemoryProfileRequest queries historical memory profiles (RFD 077).
message QueryHistoricalMemoryProfileRequest {
  string service_name = 1;                // Target service name.
  google.protobuf.Timestamp start_time = 2;  // Query start time.
  google.protobuf.Timestamp end_time = 3;    // Query end time.
}

// QueryHistoricalMemoryProfileResponse returns aggregated historical memory profiles (RFD 077).
message QueryHistoricalMemoryProfileResponse {
  repeated coral.agent.v1.MemoryStackSample samples = 1; // Raw aggregated allocation samples (for flamegraphs).
  int64 total_alloc_bytes = 2;      // Total allocation bytes across time range.
  string error = 3;                 // Error message if query failed.
  bool success = 4;                 // Whether query succeeded.
  repeated coral.agent.v1.TopAllocFunction top_functions = 5; // Top allocating functions (summarized).
  repeated coral.agent.v1.TopAllocType top_types = 6;         // Top allocation types (summarized).
  int32 unique_stacks = 7;          // Number of unique stack traces.
}
