syntax = "proto3";

package coral.colony.v1;

import "google/protobuf/timestamp.proto";
import "coral/mesh/v1/auth.proto";
import "coral/agent/v1/agent.proto";
import "coral/colony/v1/mcp.proto";

option go_package = "github.com/coral-mesh/coral/proto/colony/v1;colonypb";

// Colony management service exposed on mesh network.
service ColonyService {
  // Get colony status and health.
  rpc GetStatus(GetStatusRequest) returns (GetStatusResponse);

  // List connected agents.
  rpc ListAgents(ListAgentsRequest) returns (ListAgentsResponse);

  // Get network topology.
  rpc GetTopology(GetTopologyRequest) returns (GetTopologyResponse);

  // Query telemetry data from agent (RFD 025 - pull-based).
  rpc QueryTelemetry(QueryTelemetryRequest) returns (QueryTelemetryResponse);

  // Query aggregated eBPF metrics from colony storage (RFD 035).
  rpc QueryEbpfMetrics(coral.agent.v1.QueryEbpfMetricsRequest) returns (coral.agent.v1.QueryEbpfMetricsResponse);

  // Unified query interface (RFD 067).
  rpc QueryUnifiedSummary(QueryUnifiedSummaryRequest) returns (QueryUnifiedSummaryResponse);
  rpc QueryUnifiedTraces(QueryUnifiedTracesRequest) returns (QueryUnifiedTracesResponse);
  rpc QueryUnifiedMetrics(QueryUnifiedMetricsRequest) returns (QueryUnifiedMetricsResponse);
  rpc QueryUnifiedLogs(QueryUnifiedLogsRequest) returns (QueryUnifiedLogsResponse);


  // MCP Tool Execution (RFD 004 - MCP server integration).

  // Execute an MCP tool and return the result.
  rpc CallTool(CallToolRequest) returns (CallToolResponse);

  // Execute an MCP tool with streaming (bidirectional).
  rpc StreamTool(stream StreamToolRequest) returns (stream StreamToolResponse);

  // List available MCP tools.
  rpc ListTools(ListToolsRequest) returns (ListToolsResponse);

  // Certificate management (RFD 047 - Colony CA Infrastructure).

  // Request a client certificate using a bootstrap token.
  rpc RequestCertificate(RequestCertificateRequest) returns (RequestCertificateResponse);

  // Revoke an issued certificate.
  rpc RevokeCertificate(RevokeCertificateRequest) returns (RevokeCertificateResponse);
}

message GetStatusRequest {}

message GetStatusResponse {
  // Colony identifier.
  string colony_id = 1;

  // Application name.
  string app_name = 2;

  // Environment (e.g., "production", "staging").
  string environment = 3;

  // Status ("running", "degraded", "unhealthy").
  string status = 4;

  // When the colony started.
  google.protobuf.Timestamp started_at = 5;

  // Uptime in seconds.
  int64 uptime_seconds = 6;

  // Number of connected agents.
  int32 agent_count = 7;

  // Dashboard URL.
  string dashboard_url = 8;

  // Storage size in bytes.
  int64 storage_bytes = 9;

  // Network endpoint information.
  // WireGuard listen port (UDP).
  int32 wireguard_port = 10;

  // WireGuard public key.
  string wireguard_public_key = 11;

  // WireGuard registered endpoints (e.g., ":51820").
  repeated string wireguard_endpoints = 12;

  // Buf Connect service port (TCP).
  int32 connect_port = 13;

  // Colony mesh IPv4 address.
  string mesh_ipv4 = 14;

  // Colony mesh IPv6 address.
  string mesh_ipv6 = 15;

  // Number of active agents.
  int32 active_agent_count = 16;

  // Number of degraded agents.
  int32 degraded_agent_count = 17;
}

message ListAgentsRequest {}

message ListAgentsResponse {
  repeated Agent agents = 1;
}

message Agent {
  // Agent identifier.
  string agent_id = 1;

  // DEPRECATED: Component name (single-service mode).
  // Use 'services' field for multi-service agents.
  string component_name = 2 [deprecated = true];

  // Mesh IPv4 address.
  string mesh_ipv4 = 3;

  // Mesh IPv6 address.
  string mesh_ipv6 = 4;

  // Last seen timestamp.
  google.protobuf.Timestamp last_seen = 5;

  // Status ("healthy", "degraded", "unhealthy").
  string status = 6;

  // Services monitored by this agent (RFD 011).
  repeated coral.mesh.v1.ServiceInfo services = 7;

  // NEW: Runtime context (RFD 018).
  coral.agent.v1.RuntimeContextResponse runtime_context = 8;
}

message GetTopologyRequest {}

message GetTopologyResponse {
  // Colony identifier.
  string colony_id = 1;

  // List of agents.
  repeated Agent agents = 2;

  // List of connections between components.
  repeated Connection connections = 3;
}

message Connection {
  // Source component ID.
  string source_id = 1;

  // Target component ID.
  string target_id = 2;

  // Connection type ("http", "grpc", "database", etc.).
  string connection_type = 3;
}

// TelemetrySpan represents a filtered OpenTelemetry span stored locally on agents (RFD 025).
message TelemetrySpan {
  // Span timestamp (Unix milliseconds).
  int64 timestamp = 1;

  // OpenTelemetry trace ID.
  string trace_id = 2;

  // OpenTelemetry span ID.
  string span_id = 3;

  // Service name from span attributes.
  string service_name = 4;

  // Span kind (CLIENT, SERVER, INTERNAL, PRODUCER, CONSUMER).
  string span_kind = 5;

  // Span duration in milliseconds.
  double duration_ms = 6;

  // Whether this span represents an error.
  bool is_error = 7;

  // HTTP status code (if applicable).
  int32 http_status = 8;

  // HTTP method (if applicable).
  string http_method = 9;

  // HTTP route (if applicable).
  string http_route = 10;

  // Additional span attributes (key-value pairs).
  map<string, string> attributes = 11;
}

// QueryTelemetryRequest is sent from colony to agent to query recent telemetry (RFD 025).
message QueryTelemetryRequest {
  // Agent identifier to query.
  string agent_id = 1;

  // Start time for query range (Unix seconds).
  int64 start_time = 2;

  // End time for query range (Unix seconds).
  int64 end_time = 3;

  // Filter by service names (empty = all services).
  repeated string service_names = 4;
}

// QueryTelemetryResponse contains filtered spans from agent's local storage (RFD 025).
message QueryTelemetryResponse {
  // Agent identifier.
  string agent_id = 1;

  // Filtered spans matching the query.
  repeated TelemetrySpan spans = 2;

  // Total number of spans returned.
  int32 total_spans = 3;
}

// Certificate management messages (RFD 047 - Colony CA Infrastructure)

// RequestCertificateRequest requests a client certificate using a bootstrap token.
message RequestCertificateRequest {
  // Bootstrap token (JWT).
  string jwt = 1;

  // Certificate signing request (PEM-encoded).
  bytes csr = 2;
}

// RequestCertificateResponse returns the issued certificate.
message RequestCertificateResponse {
  // Client certificate (PEM-encoded).
  bytes certificate = 1;

  // CA certificate chain (PEM-encoded).
  bytes ca_chain = 2;

  // Certificate expiration timestamp (Unix seconds).
  int64 expires_at = 3;
}

// RevokeCertificateRequest revokes a previously issued certificate.
message RevokeCertificateRequest {
  // Certificate serial number.
  string serial_number = 1;

  // Revocation reason.
  string reason = 2;
}

// RevokeCertificateResponse confirms certificate revocation.
message RevokeCertificateResponse {
  // Revocation successful.
  bool success = 1;
}

// Unified Query Interface (RFD 067)

message QueryUnifiedSummaryRequest {
  // Optional: specific service or all services.
  string service = 1;
  
  // Time range (e.g., "5m", "1h").
  string time_range = 2;
}

message QueryUnifiedSummaryResponse {
  // Summary results as formatted text.
  string result = 1;
}

message QueryUnifiedTracesRequest {
  // Optional: filter by service.
  string service = 1;
  
  // Time range (default: "1h").
  string time_range = 2;
  
  // Optional: ebpf|telemetry|all (default: all).
  string source = 3;
  
  // Optional: specific trace ID.
  string trace_id = 4;
  
  // Optional: filter slow traces (milliseconds).
  int32 min_duration_ms = 5;
  
  // Maximum traces to return.
  int32 max_traces = 6;
}

message QueryUnifiedTracesResponse {
  // Trace results as formatted text.
  string result = 1;
}

message QueryUnifiedMetricsRequest {
  // Optional: filter by service.
  string service = 1;
  
  // Time range (default: "1h").
  string time_range = 2;
  
  // Optional: ebpf|telemetry|all (default: all).
  string source = 3;
  
  // Optional: http|grpc|sql|auto (default: auto).
  string protocol = 4;
  
  // Optional: HTTP route filter.
  string http_route = 5;
  
  // Optional: HTTP method filter.
  string http_method = 6;
  
  // Optional: HTTP status code range filter.
  string status_code_range = 7;
}

message QueryUnifiedMetricsResponse {
  // Metrics results as formatted text.
  string result = 1;
}

message QueryUnifiedLogsRequest {
  // Optional: filter by service.
  string service = 1;
  
  // Time range (default: "1h").
  string time_range = 2;
  
  // Optional: debug|info|warn|error.
  string level = 3;
  
  // Optional: full-text search.
  string search = 4;
  
  // Maximum logs to return.
  int32 max_logs = 5;
}

message QueryUnifiedLogsResponse {
  // Log results as formatted text.
  string result = 1;
}
