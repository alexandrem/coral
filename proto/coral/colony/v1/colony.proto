syntax = "proto3";

package coral.colony.v1;

import "google/protobuf/timestamp.proto";
import "coral/mesh/v1/auth.proto";
import "coral/agent/v1/agent.proto";
import "coral/colony/v1/mcp.proto";
import "coral/colony/v1/queries.proto";

option go_package = "github.com/coral-mesh/coral/proto/colony/v1;colonypb";

// Colony management service exposed on mesh network.
service ColonyService {
  // Get colony status and health.
  rpc GetStatus(GetStatusRequest) returns (GetStatusResponse);

  // List connected agents.
  rpc ListAgents(ListAgentsRequest) returns (ListAgentsResponse);

  // Get network topology.
  rpc GetTopology(GetTopologyRequest) returns (GetTopologyResponse);

  // Unified query interface (RFD 067) - comprehensive queries for detailed analysis.
  rpc QueryUnifiedSummary(QueryUnifiedSummaryRequest) returns (QueryUnifiedSummaryResponse);
  rpc QueryUnifiedTraces(QueryUnifiedTracesRequest) returns (QueryUnifiedTracesResponse);
  rpc QueryUnifiedMetrics(QueryUnifiedMetricsRequest) returns (QueryUnifiedMetricsResponse);
  rpc QueryUnifiedLogs(QueryUnifiedLogsRequest) returns (QueryUnifiedLogsResponse);

  // Focused query interface (RFD 076) - focused queries for scripting and CLI.
  rpc ListServices(ListServicesRequest) returns (ListServicesResponse);
  rpc GetMetricPercentile(GetMetricPercentileRequest) returns (GetMetricPercentileResponse);
  rpc GetServiceActivity(GetServiceActivityRequest) returns (GetServiceActivityResponse);
  rpc ListServiceActivity(ListServiceActivityRequest) returns (ListServiceActivityResponse);
  rpc ExecuteQuery(ExecuteQueryRequest) returns (ExecuteQueryResponse);

  // MCP Tool Execution (RFD 004 - MCP server integration).

  // Execute an MCP tool and return the result.
  rpc CallTool(CallToolRequest) returns (CallToolResponse);

  // Execute an MCP tool with streaming (bidirectional).
  rpc StreamTool(stream StreamToolRequest) returns (stream StreamToolResponse);

  // List available MCP tools.
  rpc ListTools(ListToolsRequest) returns (ListToolsResponse);

  // Certificate management (RFD 047 - Colony CA Infrastructure).

  // Request a client certificate using a bootstrap token.
  rpc RequestCertificate(RequestCertificateRequest) returns (RequestCertificateResponse);

  // Revoke an issued certificate.
  rpc RevokeCertificate(RevokeCertificateRequest) returns (RevokeCertificateResponse);

  // Get CA status and fingerprint (RFD 047).
  rpc GetCAStatus(GetCAStatusRequest) returns (GetCAStatusResponse);
}

message GetStatusRequest {}

message GetStatusResponse {
  // Colony identifier.
  string colony_id = 1;

  // Application name.
  string app_name = 2;

  // Environment (e.g., "production", "staging").
  string environment = 3;

  // Status ("running", "degraded", "unhealthy").
  string status = 4;

  // When the colony started.
  google.protobuf.Timestamp started_at = 5;

  // Uptime in seconds.
  int64 uptime_seconds = 6;

  // Number of connected agents.
  int32 agent_count = 7;

  // Dashboard URL.
  string dashboard_url = 8;

  // Storage size in bytes.
  int64 storage_bytes = 9;

  // Network endpoint information.
  // WireGuard listen port (UDP).
  int32 wireguard_port = 10;

  // WireGuard public key.
  string wireguard_public_key = 11;

  // WireGuard registered endpoints (e.g., ":51820").
  repeated string wireguard_endpoints = 12;

  // Buf Connect service port (TCP).
  int32 connect_port = 13;

  // Colony mesh IPv4 address.
  string mesh_ipv4 = 14;

  // Colony mesh IPv6 address.
  string mesh_ipv6 = 15;

  // Number of active agents.
  int32 active_agent_count = 16;

  // Number of degraded agents.
  int32 degraded_agent_count = 17;

  // Public endpoint URL (RFD 031).
  // Empty if public endpoint is not enabled.
  string public_endpoint_url = 18;
}

message ListAgentsRequest {}

message ListAgentsResponse {
  repeated Agent agents = 1;
}

message Agent {
  // Agent identifier.
  string agent_id = 1;

  // DEPRECATED: Component name (single-service mode).
  // Use 'services' field for multi-service agents.
  string component_name = 2 [deprecated = true];

  // Mesh IPv4 address.
  string mesh_ipv4 = 3;

  // Mesh IPv6 address.
  string mesh_ipv6 = 4;

  // Last seen timestamp.
  google.protobuf.Timestamp last_seen = 5;

  // Status ("healthy", "degraded", "unhealthy").
  string status = 6;

  // Services monitored by this agent (RFD 011).
  repeated coral.mesh.v1.ServiceInfo services = 7;

  // NEW: Runtime context (RFD 018).
  coral.agent.v1.RuntimeContextResponse runtime_context = 8;
}

message GetTopologyRequest {}

message GetTopologyResponse {
  // Colony identifier.
  string colony_id = 1;

  // List of agents.
  repeated Agent agents = 2;

  // List of connections between components.
  repeated Connection connections = 3;
}

message Connection {
  // Source component ID.
  string source_id = 1;

  // Target component ID.
  string target_id = 2;

  // Connection type ("http", "grpc", "database", etc.).
  string connection_type = 3;
}

// Certificate management messages (RFD 047 - Colony CA Infrastructure)

// RequestCertificateRequest requests a client certificate using a bootstrap token.
message RequestCertificateRequest {
  // Bootstrap token (JWT).
  string jwt = 1;

  // Certificate signing request (PEM-encoded).
  bytes csr = 2;
}

// RequestCertificateResponse returns the issued certificate.
message RequestCertificateResponse {
  // Client certificate (PEM-encoded).
  bytes certificate = 1;

  // CA certificate chain (PEM-encoded).
  bytes ca_chain = 2;

  // Certificate expiration timestamp (Unix seconds).
  int64 expires_at = 3;
}

// RevokeCertificateRequest revokes a previously issued certificate.
message RevokeCertificateRequest {
  // Certificate serial number.
  string serial_number = 1;

  // Revocation reason.
  string reason = 2;
}

// RevokeCertificateResponse confirms certificate revocation.
message RevokeCertificateResponse {
  // Revocation successful.
  bool success = 1;
}

// GetCAStatus messages (RFD 047)

message GetCAStatusRequest {}

message GetCAStatusResponse {
  message CertStatus {
    string path = 1;
    string fingerprint = 2;
    google.protobuf.Timestamp expires_at = 3;
    string subject = 4;
  }
  
  CertStatus root_ca = 1;
  CertStatus server_intermediate = 2;
  CertStatus agent_intermediate = 3;
  CertStatus policy_signing = 4;
  string colony_spiffe_id = 5;
  
  message Stats {
    int32 total_issued = 1;
    int32 active = 2;
    int32 revoked = 3;
  }
  Stats statistics = 6;
}
