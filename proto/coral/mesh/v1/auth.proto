syntax = "proto3";
package coral.mesh.v1;

import "google/protobuf/timestamp.proto";
import "coral/agent/v1/agent.proto";

option go_package = "github.com/coral-mesh/coral/coral/mesh/v1;meshv1";

// Service information for multi-service agents.
message ServiceInfo {
  string name = 1;     // "frontend", "redis", "metrics"
  int32 port = 2;                // Service port number
  string health_endpoint = 3;    // Optional: "/health", "/metrics", ""
  string service_type = 4;       // Optional: "http", "redis", "postgres", "prometheus"
  map<string, string> labels = 5; // Additional metadata

  // Process information (RFD 064).
  int32 process_id = 6;        // Process ID running the service (0 if unknown)
  string binary_path = 7;      // Path to service executable (empty if unknown)
  string binary_hash = 8;      // Hash of binary for cache invalidation (optional)
}

// Agent authentication during registration
message RegisterRequest {
  // Agent identification
  string agent_id = 1;

  // DEPRECATED: Legacy single-service field (for backward compatibility).
  // Use 'services' field for new deployments.
  string component_name = 2 [deprecated = true];  // "frontend", "api", "database"

  // Authentication (RFD 002)
  string colony_id = 3;       // Must match colony's ID
  string colony_secret = 4;   // Shared secret for auth

  // Agent metadata
  string version = 5;
  map<string, string> labels = 6;

  // WireGuard (for mesh coordination)
  string wireguard_pubkey = 7;

  // NEW: Multi-service support (RFD 011).
  // One or more services monitored by this agent.
  repeated ServiceInfo services = 10;

  // NEW: Runtime context (RFD 018).
  coral.agent.v1.RuntimeContextResponse runtime_context = 11;

  // Protocol version (RFD 018).
  string protocol_version = 12;

  // NEW: eBPF capabilities (RFD 013).
  coral.agent.v1.EbpfCapabilities ebpf_capabilities = 13;
}

message RegisterResponse {
  // Authentication result
  bool accepted = 1;
  string reason = 2;  // If rejected: "invalid_secret", "wrong_colony", "unauthorized"

  // Mesh assignment (if accepted)
  string assigned_ip = 3;      // Agent's IP in WireGuard mesh (e.g., "10.100.0.42")
  string mesh_subnet = 4;      // Colony's mesh subnet (e.g., "10.100.0.0/16")
  repeated PeerInfo peers = 5; // Other agents in mesh

  // Colony info
  google.protobuf.Timestamp registered_at = 6;
}

message PeerInfo {
  string agent_id = 1;
  string component_name = 2;
  string mesh_ip = 3;
  string wireguard_pubkey = 4;
}

// Heartbeat request from agent to keep connection alive
message HeartbeatRequest {
  string agent_id = 1;

  // Optional: agent can report current status
  string status = 2;  // "healthy", "degraded", "unhealthy"

  // Optional: updated service information
  repeated ServiceInfo services = 3;
}

message HeartbeatResponse {
  bool ok = 1;

  // Colony can send commands to agent (future use)
  repeated string commands = 2;
}

// MeshService handles agent registration and mesh coordination
service MeshService {
  // Register an agent with the colony
  rpc Register(RegisterRequest) returns (RegisterResponse);

  // Send periodic heartbeat to update last_seen timestamp
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
}
