syntax = "proto3";
package coral.mesh.v1;

import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";
import "coral/agent/v1/agent.proto";

option go_package = "github.com/coral-io/coral/coral/mesh/v1;meshv1";

// StartEbpfCollectorRequest initiates an eBPF collector on an agent.
message StartEbpfCollectorRequest {
  string agent_id = 1;
  string service_name = 2;  // optional; limit to specific workload
  coral.agent.v1.EbpfCollectorKind kind = 3;
  map<string, string> config = 4;         // collector-specific options
  google.protobuf.Duration duration = 5;  // optional; max collection time
}

// StartEbpfCollectorResponse confirms collector start.
message StartEbpfCollectorResponse {
  string collector_id = 1;
  google.protobuf.Timestamp expires_at = 2;
  bool supported = 3;  // false if eBPF not available on this agent
  string error = 4;    // error message if supported=false
}

// StopEbpfCollectorRequest stops a running collector.
message StopEbpfCollectorRequest {
  string collector_id = 1;
}

// StopEbpfCollectorResponse confirms collector stop.
message StopEbpfCollectorResponse {
  bool success = 1;
  string error = 2;
}

// EbpfEventStreamRequest requests streaming of eBPF events.
message EbpfEventStreamRequest {
  string collector_id = 1;
}

// SyscallStats contains aggregated syscall statistics.
message SyscallStats {
  string syscall_name = 1;
  uint64 call_count = 2;
  uint64 error_count = 3;
  uint64 total_duration_us = 4;  // total time in microseconds
  map<string, string> labels = 5;
}

// HttpLatencyHistogram contains HTTP request latency distribution.
message HttpLatencyHistogram {
  repeated double buckets = 1;      // bucket boundaries in milliseconds
  repeated uint64 counts = 2;       // event count per bucket
  string unit = 3;                  // "milliseconds"
  map<string, string> labels = 4;   // method, status, pod, etc.
}

// CpuProfileSample contains a CPU profile stack sample.
message CpuProfileSample {
  repeated string stack = 1;        // symbolized stack frames (top-to-bottom)
  uint64 count = 2;                 // sample count for this stack
  map<string, string> labels = 3;
}

// EbpfEvent represents a single eBPF event or aggregated summary.
message EbpfEvent {
  google.protobuf.Timestamp timestamp = 1;
  string collector_id = 2;
  string agent_id = 3;
  string service_name = 4;

  oneof payload {
    SyscallStats syscall_stats = 10;
    HttpLatencyHistogram http_latency = 11;
    CpuProfileSample cpu_profile = 12;
  }
}

// EbpfService handles eBPF collector management.
service EbpfService {
  // Start an eBPF collector on an agent.
  rpc StartCollector(StartEbpfCollectorRequest) returns (StartEbpfCollectorResponse);

  // Stop a running eBPF collector.
  rpc StopCollector(StopEbpfCollectorRequest) returns (StopEbpfCollectorResponse);

  // Stream eBPF events from a collector.
  rpc StreamEvents(EbpfEventStreamRequest) returns (stream EbpfEvent);
}
