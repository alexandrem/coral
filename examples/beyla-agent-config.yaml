# Example Coral agent configuration with Beyla integration (RFD 032)
# This demonstrates how to configure Beyla for RED metrics collection

# Beyla integration configuration
beyla:
    enabled: true

    # Discovery: which processes to instrument
    discovery:
        services:
            # Instrument service listening on port 8080
            -   name: "checkout-api"
                open_port: 8080

            # Instrument service by Kubernetes pod name pattern
            -   name: "payments-api"
                k8s_pod_name: "payments-*"
                k8s_namespace: "prod"

            # Instrument service by Kubernetes labels
            -   name: "inventory-svc"
                k8s_namespace: "prod"
                k8s_pod_label:
                    app: "inventory"
                    version: "v2"

    # Protocol-specific configuration
    protocols:
        http:
            enabled: true
            capture_headers: false  # Privacy: don't store header values
            route_patterns: # Cardinality reduction
                - "/api/v1/users/:id"
                - "/api/v1/orders/:id"
                - "/api/v1/products/:id"

        grpc:
            enabled: true

        sql:
            enabled: true
            obfuscate_queries: true  # Replace literals with "?"

        kafka:
            enabled: false

        redis:
            enabled: false

    # Attributes to add to all metrics/traces
    attributes:
        environment: "production"
        cluster: "us-west-2"
        colony_id: "colony-abc123"
        region: "us-west-2"

    # Performance tuning
    sampling:
        rate: 1.0  # 100% sampling (adjust if overhead too high)

    # Resource limits
    limits:
        max_traced_connections: 1000  # Prevent memory exhaustion
        ring_buffer_size: 65536

    # OTLP endpoint (local receiver from RFD 025)
    otlp_endpoint: "localhost:4318"
