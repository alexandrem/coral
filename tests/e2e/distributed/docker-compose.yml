version: '3.8'

# E2E Test Infrastructure
# This compose file starts all services needed for E2E tests:
# - Discovery service
# - Colony (coordinator)
# - Agents (2 instances for multi-agent tests)
# - Test apps (CPU, OTEL, SDK)

services:
  # Discovery Service - NAT traversal and service registry
  discovery:
    build:
      context: ../../..
      dockerfile: cmd/discovery/Dockerfile
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - coral-e2e

  # Colony - AI coordinator with DuckDB storage
  colony:
    build:
      context: ../../..
      dockerfile: Dockerfile
    command:
      - colony
      - start
      - --colony-id=test-colony-e2e
      - --discovery-endpoint=http://discovery:8080
    environment:
      - CORAL_COLONY_SECRET=test-secret-12345
    ports:
      - "9000:9000"
      - "51820:51820/udp"
    privileged: true  # Required for WireGuard
    depends_on:
      discovery:
        condition: service_healthy
    networks:
      - coral-e2e
    volumes:
      - colony-data:/var/lib/coral

  # Agent 0 - Primary agent
  agent-0:
    build:
      context: ../../..
      dockerfile: Dockerfile
    command:
      - agent
      - start
      - --agent-id=agent-0
      - --colony-id=test-colony-e2e
      - --discovery-endpoint=http://discovery:8080
      - --monitor-all  # Enable Beyla for all listening processes
    environment:
      - CORAL_COLONY_SECRET=test-secret-12345
    ports:
      - "4317:4317"  # OTLP gRPC
      - "4318:4318"  # OTLP HTTP
      - "9001:9000"  # Agent gRPC
    privileged: true  # Required for eBPF and WireGuard
    depends_on:
      - colony
    networks:
      - coral-e2e
    volumes:
      - agent-0-data:/var/lib/coral

  # Agent 1 - Secondary agent for multi-agent tests
  agent-1:
    build:
      context: ../../..
      dockerfile: Dockerfile
    command:
      - agent
      - start
      - --agent-id=agent-1
      - --colony-id=test-colony-e2e
      - --discovery-endpoint=http://discovery:8080
      - --monitor-all
    environment:
      - CORAL_COLONY_SECRET=test-secret-12345
    ports:
      - "4327:4317"  # OTLP gRPC
      - "4328:4318"  # OTLP HTTP
      - "9002:9000"  # Agent gRPC
    privileged: true
    depends_on:
      - colony
    networks:
      - coral-e2e
    volumes:
      - agent-1-data:/var/lib/coral

  # CPU App - CPU-intensive test application
  cpu-app:
    build:
      context: ../../..
      dockerfile: tests/e2e/cpu-profile/cpu-intensive-app/Dockerfile
    ports:
      - "8081:8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - coral-e2e

  # OTEL App - OpenTelemetry instrumented application
  otel-app:
    build:
      context: ../../..
      dockerfile: tests/e2e/distributed/fixtures/apps/otel-app/Dockerfile
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=agent-0:4317
    ports:
      - "8082:8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    depends_on:
      - agent-0
    networks:
      - coral-e2e

  # SDK App - Application with Coral SDK for uprobe testing
  sdk-app:
    build:
      context: ../../..
      dockerfile: tests/e2e/distributed/fixtures/apps/sdk-app/Dockerfile
    ports:
      - "3001:3001"
      - "9003:9002"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - coral-e2e

networks:
  coral-e2e:
    driver: bridge

volumes:
  colony-data:
  agent-0-data:
  agent-1-data:
