version: "3.8"

# E2E Test Infrastructure
# This compose file starts all services needed for E2E tests:
# - Discovery service
# - Colony (coordinator)
# - Agents (2 instances for multi-agent tests)
# - Test apps (CPU, OTEL, SDK)

services:
  # Discovery Service - NAT traversal and service registry
  discovery:
    build:
      context: ../../..
      dockerfile: cmd/discovery/Dockerfile
    # No shared secret needed for Discovery (uses Ed25519 keys)
    command:
      - -log-level=debug
      - --key-storage=/tmp/discovery-keys.json
    ports:
      - "18080:8080" # Use non-standard port to avoid conflicts with local dev
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 15s
    networks:
      - coral-e2e

  # Colony - AI coordinator with DuckDB storage
  colony:
    build:
      context: ../../..
      dockerfile: Dockerfile
    entrypoint: /bin/sh
    command:
      - -c
      - |
        # Initialize colony if config doesn't exist
        if [ ! -f /var/lib/coral/.colony_id ] || [ ! -d /root/.coral/colonies/test-colony-e2e-* ]; then
          echo "Initializing colony..."
          /usr/local/bin/coral init test-colony-e2e --env e2e --storage /var/lib/coral --discovery http://discovery:8080
          # Find the generated colony directory
          COLONY_DIR=$$(ls -1d /root/.coral/colonies/test-colony-e2e-* 2>/dev/null | head -1)
          if [ -n "$$COLONY_DIR" ]; then
            COLONY_ID=$$(basename "$$COLONY_DIR")
            echo "$$COLONY_ID" > /var/lib/coral/.colony_id
            # Share colony ID with agents
            echo "$$COLONY_ID" > /shared/colony_id
            echo "Colony ID saved to shared volume: $$COLONY_ID"

            # Calculate and share Root CA fingerprint for agent bootstrap (RFD 048)
            ROOT_CA_PATH="$$COLONY_DIR/ca/root-ca.crt"
            if [ -f "$$ROOT_CA_PATH" ]; then
              # Calculate SHA256 fingerprint of the Root CA certificate
              FINGERPRINT=$$(openssl x509 -in "$$ROOT_CA_PATH" -noout -fingerprint -sha256 | sed 's/.*=//;s/://g' | tr '[:upper:]' '[:lower:]')
              echo "sha256:$$FINGERPRINT" > /shared/ca_fingerprint
              echo "CA fingerprint saved: sha256:$$FINGERPRINT"
            fi
          fi
        else
          echo "Colony already initialized, using existing config"
          # Ensure colony ID is shared
          if [ -f /var/lib/coral/.colony_id ]; then
            cp /var/lib/coral/.colony_id /shared/colony_id
            # Also ensure fingerprint is shared
            COLONY_ID=$$(cat /var/lib/coral/.colony_id)
            COLONY_DIR="/root/.coral/colonies/$$COLONY_ID"
            ROOT_CA_PATH="$$COLONY_DIR/ca/root-ca.crt"
            if [ -f "$$ROOT_CA_PATH" ] && [ ! -f /shared/ca_fingerprint ]; then
              FINGERPRINT=$$(openssl x509 -in "$$ROOT_CA_PATH" -noout -fingerprint -sha256 | sed 's/.*=//;s/://g' | tr '[:upper:]' '[:lower:]')
              echo "sha256:$$FINGERPRINT" > /shared/ca_fingerprint
              echo "CA fingerprint saved: sha256:$$FINGERPRINT"
            fi
          fi
        fi
        # Read the actual colony ID and configure e2e-specific settings
        if [ -f /var/lib/coral/.colony_id ]; then
          COLONY_ID=$$(cat /var/lib/coral/.colony_id)
          echo "Starting colony with ID: $$COLONY_ID"

          # Apply public endpoint settings via overlay (still needed in config for now)
          CONFIG_FILE="/root/.coral/colonies/$$COLONY_ID/config.yaml"
          if [ -f "$$CONFIG_FILE" ] && [ ! -f "$$CONFIG_FILE.e2e_applied" ]; then
            echo "Applying e2e public endpoint settings..."
            printf "\npublic_endpoint:\n  enabled: true\n  host: 0.0.0.0\n  port: 8443\n  auth:\n    require: true\n" >> "$$CONFIG_FILE"
            touch "$$CONFIG_FILE.e2e_applied"
          fi

          exec /usr/local/bin/coral colony start --colony "$$COLONY_ID"
        else
          # Fallback to auto-detection
          exec /usr/local/bin/coral colony start
        fi
    environment:
      - CORAL_DISCOVERY_ENDPOINT=http://discovery:8080
      - CORAL_PUBLIC_ENDPOINT=colony:51820
      - CORAL_STORAGE_PATH=/var/lib/coral
      - CORAL_SERVICES_POLL_INTERVAL=1s
      - CORAL_TELEMETRY_POLL_INTERVAL=1s
      - CORAL_BEYLA_POLL_INTERVAL=1s
      - CORAL_SYSTEM_METRICS_POLL_INTERVAL=1s
      - CORAL_PROFILING_POLL_INTERVAL=1s
      - CORAL_DISCOVERY_REGISTER_INTERVAL=1s
    ports:
      - "9000:9000"
      - "8443:8443"
      - "51820:51820/udp"
    privileged: true # Required for WireGuard
    depends_on:
      discovery:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "coral", "colony", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - coral-e2e
    volumes:
      - colony-data:/var/lib/coral
      - colony-shared:/shared
      - colony-config:/root/.coral
      - ./fixtures:/fixtures:ro # Mount fixtures directory for e2e config overlay

  # Agent 0 - Primary agent
  agent-0:
    build:
      context: ../../..
      dockerfile: Dockerfile
    entrypoint: /bin/sh
    command:
      - -c
      - |
        # Wait for colony to write its ID and CA fingerprint
        echo "Waiting for colony initialization..."
        while [ ! -f /shared/colony_id ]; do
          echo "  Waiting for colony ID..."
          sleep 2
        done
        while [ ! -f /shared/ca_fingerprint ]; do
          echo "  Waiting for CA fingerprint..."
          sleep 2
        done
        COLONY_ID=$$(cat /shared/colony_id)
        CA_FINGERPRINT=$$(cat /shared/ca_fingerprint)
        echo "Starting agent with colony ID: $$COLONY_ID"
        echo "Using CA fingerprint: $$CA_FINGERPRINT"
        export CORAL_COLONY_ID="$$COLONY_ID"
        export CORAL_CA_FINGERPRINT="$$CA_FINGERPRINT"
        # Bootstrap client will retry colony lookup with exponential backoff
        exec /usr/local/bin/coral agent start --monitor-all
    environment:
      - CORAL_DISCOVERY_ENDPOINT=http://discovery:8080
      - CORAL_AGENT_BIND_ALL=true
      - CORAL_HEARTBEAT_INTERVAL=5s
    ports:
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
      - "9001:9001" # Agent gRPC
      - "8081:8080" # CPU app (shared network namespace for Beyla)
      - "8082:8090" # OTEL app (shared network namespace for Beyla + OTLP)
    privileged: true # Required for eBPF and WireGuard
    depends_on:
      - colony
    healthcheck:
      test: ["CMD", "coral", "agent", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - coral-e2e
    volumes:
      - agent-0-data:/var/lib/coral
      - colony-shared:/shared
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

  # Agent 1 - Secondary agent for multi-agent tests
  agent-1:
    build:
      context: ../../..
      dockerfile: Dockerfile
    entrypoint: /bin/sh
    command:
      - -c
      - |
        # Wait for colony to write its ID and CA fingerprint
        echo "Waiting for colony initialization..."
        while [ ! -f /shared/colony_id ]; do
          echo "  Waiting for colony ID..."
          sleep 2
        done
        while [ ! -f /shared/ca_fingerprint ]; do
          echo "  Waiting for CA fingerprint..."
          sleep 2
        done
        COLONY_ID=$$(cat /shared/colony_id)
        CA_FINGERPRINT=$$(cat /shared/ca_fingerprint)
        echo "Starting agent with colony ID: $$COLONY_ID"
        echo "Using CA fingerprint: $$CA_FINGERPRINT"
        export CORAL_COLONY_ID="$$COLONY_ID"
        export CORAL_CA_FINGERPRINT="$$CA_FINGERPRINT"
        exec /usr/local/bin/coral agent start --monitor-all
    environment:
      - CORAL_DISCOVERY_ENDPOINT=http://discovery:8080
      - CORAL_AGENT_BIND_ALL=true
      - CORAL_HEARTBEAT_INTERVAL=5s
    ports:
      - "4327:4317" # OTLP gRPC
      - "4328:4318" # OTLP HTTP
      - "9002:9001" # Agent gRPC
      - "3001:3001" # SDK app HTTP (shared network namespace)
      - "9003:9002" # SDK app debug endpoint (shared network namespace)
    privileged: true
    depends_on:
      - colony
    healthcheck:
      test: ["CMD", "coral", "agent", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - coral-e2e
    volumes:
      - agent-1-data:/var/lib/coral
      - colony-shared:/shared
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

  # CPU App - CPU-intensive test application
  # Runs in agent-0's network AND PID namespace so Beyla can instrument it via eBPF
  cpu-app:
    build:
      context: ../../..
      dockerfile: tests/e2e/distributed/fixtures/apps/cpu-app/Dockerfile
    network_mode: "service:agent-0"
    pid: "service:agent-0"
    depends_on:
      agent-0:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s

  # OTEL App - OpenTelemetry instrumented application
  # Runs in agent-0's network AND PID namespace so Beyla can instrument it via eBPF
  # This tests the combination of Beyla (passive) + OTLP SDK (active) together
  otel-app:
    build:
      context: ../../..
      dockerfile: tests/e2e/distributed/fixtures/apps/otel-app/Dockerfile
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=127.0.0.1:4317
      - HTTP_PORT=8090
    network_mode: "service:agent-0"
    pid: "service:agent-0"
    depends_on:
      agent-0:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8090/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s

  # SDK App - Application with Coral SDK for uprobe testing
  # Runs in agent-1's network AND PID namespace so agent can profile it
  sdk-app:
    build:
      context: ../../..
      dockerfile: tests/e2e/distributed/fixtures/apps/sdk-app/Dockerfile
    network_mode: "service:agent-1"
    pid: "service:agent-1"
    depends_on:
      - agent-1
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s

networks:
  coral-e2e:
    driver: bridge

volumes:
  colony-data:
  discovery-data:
  agent-0-data:
  agent-1-data:
  colony-shared: # Shared volume for colony ID
  colony-config: # Persist colony config across restarts
