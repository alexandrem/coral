# E2E Test overlay - local discovery service
# Usage: docker-compose --project-directory ../../.. -f ../../../docker-compose.yml -f docker-compose.e2e.yml -f docker-compose.e2e-local-discovery.yml up -d

name: coral-e2e
services:
  # Local Discovery Service - Cloudflare Workers compatible, running via wrangler
  discovery:
    build:
      context: ../
      dockerfile: coral-discovery-workers/Dockerfile
    environment:
      - DISCOVERY_SIGNING_KEY={"id":"01H7X0X7X0X7X0X7X0X7X0X7X0","privateKey":"hXIqNNX5M2H9WuNmTPcAYgwRSWpJMqONpL3HPPoxsdoitbpmLL7H2ArTXJV0YXj89bxfbePj0GTKqEB+N9g8SA=="}
      - ENVIRONMENT=test
      - DEFAULT_TTL_SECONDS=10
      - CLEANUP_INTERVAL_MS=5000
    ports:
      - "18080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - coral

  # Override colony to use local discovery
  colony:
    environment:
      - CORAL_DISCOVERY_ENDPOINT=http://discovery:8080
    depends_on:
      discovery:
        condition: service_healthy

  # Override agents to use local discovery
  agent-0:
    environment:
      - CORAL_DISCOVERY_ENDPOINT=http://discovery:8080

  agent-1:
    environment:
      - CORAL_DISCOVERY_ENDPOINT=http://discovery:8080
